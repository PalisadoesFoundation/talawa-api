pre-commit:
  commands:
    1_upgrade_drizzle_metadata:
      run: |
        set -e
        pnpm run upgrade_drizzle_metadata
        git add ./drizzle_migrations
    2_generate_drizzle_migrations:
      run: |
        set -e
        pnpm run generate_drizzle_migrations
        git add ./drizzle_migrations
    3_check_drizzle_migrations:
      run: pnpm run check_drizzle_migrations
    4_generate_graphql_sdl_file:
      run: |
        set -e
        pnpm generate_graphql_sdl_file
        git add ./schema.graphql
    5_generate_gql_tada_files:
      run: |
        set -e
        pnpm generate_gql_tada
        git add ./test/graphql/types/gql.tada-cache.d.ts
    6_check_gql_tada:
      run: pnpm check_gql_tada
    7_fix_code_quality:
      run: |
        set -e
        pnpm fix_code_quality
        git add {staged_files}
    8_check_type_errors:
      run: pnpm check_type_errors

    9_docs_check_code_quality:
      glob: "docs/**/*.{ts,tsx,js,jsx,json,jsonc}"
      run: |
        set -e
        files="{staged_files}"
        # Consider only files under docs/
        docs_files=$(printf '%s\n' $files | grep '^docs/' || true)
        # Convert to paths relative to docs/ for pnpm -C docs
        rel_files=$(printf '%s\n' $docs_files | sed 's|^docs/||')
        # Keep only files that still exist (avoid Biome io errors)
        existing_rel_files=$(printf '%s\n' $rel_files | xargs -I{} sh -c '[ -f "docs/{}" ] && echo {}' || true)
        if [ -n "$existing_rel_files" ]; then
          # Fix only the originally staged docs files
          pnpm -C docs fix_code_quality -- $existing_rel_files
          # Re-add only those originally staged docs files
          git add -- $docs_files
          # Verify no remaining warnings on those files
          pnpm -C docs check_code_quality -- $existing_rel_files
        fi

    10_docs_check_type_errors:
      glob: "docs/**/*.{ts,tsx,js,jsx}"
      run: |
        set -e
          pnpm -C docs check_type_errors
    # commenting out because postgenerate script is not present in develop branch
    # 11_generate_docs:
    #   run: |
    #     set -e
    #     pnpm generate:docs
    #     git add ./docs/docs/docs/auto-schema

  piped: true
