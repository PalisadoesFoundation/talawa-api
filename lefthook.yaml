pre-commit:
  commands:
    1_upgrade_drizzle_metadata:
      run: |
        set -e
        pnpm run upgrade_drizzle_metadata
        git add ./drizzle_migrations
    2_generate_drizzle_migrations:
      run: |
        set -e
        pnpm run generate_drizzle_migrations
        git add ./drizzle_migrations
    3_check_drizzle_migrations:
      run: pnpm run check_drizzle_migrations
    4_generate_graphql_sdl_file:
      run: |
        set -e
        pnpm generate_graphql_sdl_file
        git add ./schema.graphql
    5_generate_gql_tada_files:
      run: |
        set -e
        pnpm generate_gql_tada
        git add ./test/graphql/types/gql.tada-cache.d.ts
    6_check_gql_tada:
      run: pnpm check_gql_tada
    7_fix_code_quality:
      run: |
        set -e
        pnpm format:fix
        git add -- {staged_files}        
        git add docs/

    7.5_check_tsdoc:
      glob: "src/**/*.ts"
      run: pnpm lint:tsdoc {staged_files}

    # TODO: Remove || echo fallback after legacy code migration (target: Q2 2026)
    7.6_validate_error_handling:
      run: pnpm run validate:error-handling || echo "Error handling validation warnings"
      glob: "src/**/*.{ts,js}"

    8_check_type_errors:
      run: pnpm typecheck

    9_check_mock_isolation:
      glob: "test/**/*.{test,spec}.{ts,tsx}"
      run: pnpm run check_mock_isolation {staged_files}

    10_check_disable_statements:
      glob: "**/*.{ts,tsx}"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/disable_statements_check.py --repo=api --files {staged_files}
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/biome_disable_check.py --files {staged_files}
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi

    11.2_check_code_coverage_disable:
      glob: "**/*.{ts,tsx}"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/code_coverage_disable_check.py --files {staged_files}
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/code_coverage_disable_check.py --files {staged_files}
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi

    11.3_check_ts_ignore:
      glob: "**/*.{ts,tsx}"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/detect_ts_ignore.py --files {staged_files}
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/detect_ts_ignore.py --files {staged_files}
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi

    11.4_check_sanitization_disable:
      glob: "**/*.ts"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/check_sanitization_disable.py --files {staged_files}
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/check_sanitization_disable.py --files {staged_files}
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi

    11.5_check_itskip:
      glob: "test/**/*.{test,spec}.{ts,tsx}"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/itskip_disable_check.py --files {staged_files}
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/itskip_disable_check.py --files {staged_files}
          .venv/Scripts/python.exe .github/workflows/scripts/disable_statements_check.py --repo=api --files {staged_files}
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi

    12_check_python_docstrings:
      glob: ".github/**/*.py"
      run: |
        set -e
        if [ -f .venv/bin/python3 ]; then
          .venv/bin/python3 .github/workflows/scripts/check_docstrings.py --directories .github
        elif [ -f .venv/Scripts/python.exe ]; then
          .venv/Scripts/python.exe .github/workflows/scripts/check_docstrings.py --directories .github
        else
          echo "Error: Python virtual environment not found."
          echo "Please ensure Python 3.9+ is installed. If 'python3 -m venv' fails, you may need to install:"
          echo "  - Ubuntu/Debian: sudo apt install python3-venv"
          echo "  - Fedora/RHEL: sudo dnf install python3-venv"
          echo "  - macOS/Windows: venv is included with Python"
          echo ""
          echo "Then run: python3 -m venv .venv && source .venv/bin/activate && pip install -r .github/workflows/requirements.txt"
          exit 1
        fi


    13_generate_docs:
      run: |
        set -e
        pnpm generate-docs
        git add ./docs/docs/auto-docs/

    14_api_schema_docs:
      run: |
        set -e
        cd docs
        pnpm docusaurus graphql-to-doc
        git add docs/auto-schema

  piped: true