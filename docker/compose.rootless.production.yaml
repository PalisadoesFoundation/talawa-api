# Rootless Docker production compose override.
#
# This file exists to support running Talawa API with Docker Engine in rootless mode.
# A common rootless limitation is publishing privileged host ports (<1024), so this
# override replaces Caddy's published ports with unprivileged defaults (8080/8443).
#
# NOTE: This file uses the Compose `!override` YAML tag (e.g. `caddy -> ports: !override`),
# which requires Docker Compose v2.24.4+; older versions may fail to parse this YAML.
#
# Use this file *in addition to* the main compose.yaml, e.g. via:
#   COMPOSE_FILE=./compose.yaml:./docker/compose.rootless.production.yaml
#   docker compose up
#
# Docs: https://docs.docker.com/engine/security/rootless/
services:
  api:
    # Inject service-level credentials into the API container solely for the
    # `assertSecretsPresent` startup check (see `src/createServer.ts`).
    # Trade-off: the API process can see MINIO_ROOT_PASSWORD / POSTGRES_PASSWORD, even
    # though it primarily needs API_MINIO_SECRET_KEY / API_POSTGRES_PASSWORD.
    environment:
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:?error}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?error}
      # API_COOKIE_SECRET is required by the API runtime schema but is not passed via the base
      # compose.yaml environment list; include it here for the rootless-production path.
      - API_COOKIE_SECRET=${API_COOKIE_SECRET:?error}
    # Rootless mode uses FUSE-overlayfs and user-namespace remapping, which makes
    # filesystem I/O and process startup noticeably slower than rootful mode.
    # Override the base healthcheck with more generous timing so the API has
    # enough time to run Drizzle migrations and connect to Postgres/Redis/MinIO
    # before being declared unhealthy.
    healthcheck:
      interval: 10s
      retries: 5
      start_interval: 2s
      start_period: 30s
      test: ["CMD-SHELL", "node /home/talawa/api/docker/apiHealthcheck.js"]
      timeout: 10s
  caddy:
    # Replace the base ports list so we don't publish 80/443 by default in rootless mode.
    ports: !override
      - name: caddy_http
        published: ${CADDY_HTTP_MAPPED_PORT:-8080}
        target: 80
      - name: caddy_https
        published: ${CADDY_HTTPS_MAPPED_PORT:-8443}
        target: 443
      - name: caddy_http3
        protocol: udp
        published: ${CADDY_HTTP3_MAPPED_PORT:-8443}
        target: 443
