"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[22206],{55288:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>a});var s=i(30758);const r={},l=s.createContext(r);function t(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(l.Provider,{value:n},e.children)}},85925:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"docs/developer-resources/best-practices/email-service-guide","title":"Email Service Guide","description":"This document explains the email service architecture in Talawa API, how to use it, and how to extend it with new providers.","source":"@site/docs/docs/developer-resources/best-practices/email.md","sourceDirName":"docs/developer-resources/best-practices","slug":"/developer-resources/email-service-guide","permalink":"/docs/developer-resources/email-service-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/PalisadoesFoundation/talawa-api/edit/develop/docs/docs/docs/developer-resources/best-practices/email.md","tags":[],"version":"current","sidebarPosition":90,"frontMatter":{"id":"email-service-guide","title":"Email Service Guide","slug":"/developer-resources/email-service-guide","sidebar_position":90},"sidebar":"tutorialSidebar","previous":{"title":"Authentication and Authorization Guide","permalink":"/docs/developer-resources/authentication-authorization-guide"},"next":{"title":"Plugin System","permalink":"/docs/developer-resources/plugin"}}');var r=i(86070),l=i(55288);const t={id:"email-service-guide",title:"Email Service Guide",slug:"/developer-resources/email-service-guide",sidebar_position:90},a=void 0,o={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"High-Level Structure",id:"high-level-structure",level:3},{value:"Component Responsibilities",id:"component-responsibilities",level:3},{value:"Strategy Pattern Implementation",id:"strategy-pattern-implementation",level:2},{value:"The IEmailProvider Interface",id:"the-iemailprovider-interface",level:3},{value:"Email Job Structure",id:"email-job-structure",level:3},{value:"Email Result Structure",id:"email-result-structure",level:3},{value:"Provider Selection",id:"provider-selection",level:3},{value:"AWS SES Provider",id:"aws-ses-provider",level:2},{value:"Configuration",id:"configuration",level:3},{value:"SES Provider Features",id:"ses-provider-features",level:3},{value:"SMTP Provider",id:"smtp-provider",level:2},{value:"Configuration",id:"configuration-1",level:3},{value:"SMTP Provider Features",id:"smtp-provider-features",level:3},{value:"Common SMTP Configurations",id:"common-smtp-configurations",level:3},{value:"SMTP Security Best Practices",id:"smtp-security-best-practices",level:3},{value:"Provider Comparison",id:"provider-comparison",level:2},{value:"Email Queue System",id:"email-queue-system",level:2},{value:"Database Schema",id:"database-schema",level:3},{value:"Queue Processing",id:"queue-processing",level:3},{value:"Retry Logic",id:"retry-logic",level:3},{value:"How to Use the Email Service",id:"how-to-use-the-email-service",level:2},{value:"Sending a Single Email",id:"sending-a-single-email",level:3},{value:"Queuing Emails for Background Processing",id:"queuing-emails-for-background-processing",level:3},{value:"Sending Bulk Emails",id:"sending-bulk-emails",level:3},{value:"Adding a New Email Provider",id:"adding-a-new-email-provider",level:2},{value:"Step 1: Create Provider Implementation",id:"step-1-create-provider-implementation",level:3},{value:"Step 2: Update Factory",id:"step-2-update-factory",level:3},{value:"Step 3: Update Environment Schema",id:"step-3-update-environment-schema",level:3},{value:"Step 4: Add Tests",id:"step-4-add-tests",level:3},{value:"Step 5: Update Documentation",id:"step-5-update-documentation",level:3},{value:"Configuration Reference",id:"configuration-reference",level:2},{value:"Environment Variables",id:"environment-variables",level:3},{value:"Configuration Validation",id:"configuration-validation",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Email Not Sending",id:"email-not-sending",level:3},{value:"AWS SES Issues",id:"aws-ses-issues",level:3},{value:"SMTP Issues",id:"smtp-issues",level:3},{value:"Queue Processor Issues",id:"queue-processor-issues",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Queue Non-Critical Emails",id:"1-always-queue-non-critical-emails",level:3},{value:"2. Always Provide Plain Text Alternative",id:"2-always-provide-plain-text-alternative",level:3},{value:"3. Use Descriptive Subjects",id:"3-use-descriptive-subjects",level:3},{value:"4. Handle Send Failures Gracefully",id:"4-handle-send-failures-gracefully",level:3},{value:"5. Respect User Preferences",id:"5-respect-user-preferences",level:3},{value:"6. Rate Limit Bulk Operations",id:"6-rate-limit-bulk-operations",level:3},{value:"7. Test Email Templates",id:"7-test-email-templates",level:3},{value:"8. Monitor Email Metrics",id:"8-monitor-email-metrics",level:3},{value:"Testing",id:"testing",level:2},{value:"Unit Testing Email Providers",id:"unit-testing-email-providers",level:3},{value:"Integration Testing Queue",id:"integration-testing-queue",level:3},{value:"Testing Email Templates",id:"testing-email-templates",level:3},{value:"Future Improvements",id:"future-improvements",level:2},{value:"Planned Features",id:"planned-features",level:3},{value:"Summary",id:"summary",level:2},{value:"Performance Optimizations",id:"performance-optimizations",level:3},{value:"Related Documentation",id:"related-documentation",level:2},{value:"Summary",id:"summary-1",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This document explains the email service architecture in Talawa API, how to use it, and how to extend it with new providers."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The Talawa API email service is built using the ",(0,r.jsx)(n.strong,{children:"Strategy Pattern"}),", allowing support for multiple email providers (AWS SES, SMTP, etc.) without code duplication. The system includes an asynchronous queue for reliable email delivery and automatic retry logic for failed emails."]}),"\n",(0,r.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(n.h3,{id:"high-level-structure",children:"High-Level Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/services/email/\n\u251c\u2500\u2500 types.ts                      # Core interfaces and types\n\u251c\u2500\u2500 providers/\n\u2502   \u251c\u2500\u2500 SESProvider.ts            #AWS SES implementation\n\u2502   \u2514\u2500\u2500 SMTPProvider.ts           # SMTP implementation\n\u251c\u2500\u2500 EmailProviderFactory.ts      # Provider selection logic\n\u251c\u2500\u2500 EmailQueueProcessor.ts       # Queue processing and retry logic\n\u2514\u2500\u2500 emailServiceInstance.ts      # Service initialization\n"})}),"\n",(0,r.jsx)(n.h3,{id:"component-responsibilities",children:"Component Responsibilities"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"types.ts"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Defines ",(0,r.jsx)(n.code,{children:"IEmailProvider"})," interface (contract for all providers)"]}),"\n",(0,r.jsxs)(n.li,{children:["Defines ",(0,r.jsx)(n.code,{children:"EmailJob"})," type (email data structure)"]}),"\n",(0,r.jsxs)(n.li,{children:["Defines ",(0,r.jsx)(n.code,{children:"EmailResult"})," type (sending result structure)"]}),"\n",(0,r.jsx)(n.li,{children:"Contains shared types used across the email system"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"EmailProviderFactory"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Reads ",(0,r.jsx)(n.code,{children:"API_EMAIL_PROVIDER"})," environment variable"]}),"\n",(0,r.jsx)(n.li,{children:"Instantiates the appropriate provider"}),"\n",(0,r.jsx)(n.li,{children:"Validates provider configuration"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"EmailQueueProcessor"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Fetches pending emails from database"}),"\n",(0,r.jsx)(n.li,{children:"Sends emails in batches using the configured provider"}),"\n",(0,r.jsx)(n.li,{children:"Handles failures with exponential backoff retry"}),"\n",(0,r.jsx)(n.li,{children:"Updates email status in database"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"emailServiceInstance"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Manages singleton instances"}),"\n",(0,r.jsx)(n.li,{children:"Initializes background queue processor"}),"\n",(0,r.jsx)(n.li,{children:"Provides clean shutdown mechanism"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"strategy-pattern-implementation",children:"Strategy Pattern Implementation"}),"\n",(0,r.jsx)(n.h3,{id:"the-iemailprovider-interface",children:"The IEmailProvider Interface"}),"\n",(0,r.jsx)(n.p,{children:"All email providers must implement this interface:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface IEmailProvider {\n  /**\n   * Send a single email\n   * @param job - Email job containing recipient, subject, body, etc.\n   * @returns Promise with send result (success status, messageId, error)\n   */\n  sendEmail(job: EmailJob): Promise<EmailResult>;\n\n  /**\n   * Send multiple emails (bulk operation)\n   * @param jobs - Array of email jobs\n   * @returns Promise with array of send results\n   */\n  sendBulkEmails(jobs: EmailJob[]): Promise<EmailResult[]>;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"email-job-structure",children:"Email Job Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface EmailJob {\n  id: string;           // Unique identifier for tracking\n  email: string;        // Recipient email address\n  subject: string;      // Email subject line\n  htmlBody: string;     // HTML email content\n  textBody?: string;    // Plain text fallback (optional)\n  userId: string | null; // Associated user ID (for audit trail)\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"email-result-structure",children:"Email Result Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface EmailResult {\n  id: string;           // Job ID from EmailJob\n  success: boolean;     // Whether email was sent successfully\n  messageId?: string;   // Provider's message ID (for tracking)\n  error?: string;       // Error message if failed\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"##Email Providers"}),"\n",(0,r.jsx)(n.p,{children:"The Talawa API supports multiple email providers through the Strategy Pattern. You can choose between AWS SES (managed cloud service) or SMTP (standard protocol) based on your deployment needs."}),"\n",(0,r.jsx)(n.h3,{id:"provider-selection",children:"Provider Selection"}),"\n",(0,r.jsx)(n.p,{children:"Set the provider via environment variable:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"API_EMAIL_PROVIDER=ses   # Use AWS SES (default)\n# or\nAPI_EMAIL_PROVIDER=smtp  # Use SMTP\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"aws-ses-provider",children:"AWS SES Provider"}),"\n",(0,r.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The SES provider requires the following environment variables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Email Provider Selection\nAPI_EMAIL_PROVIDER=ses\n\n# AWS Configuration\nAWS_SES_REGION=us-east-1          # Required: AWS region\nAWS_ACCESS_KEY_ID=AKIA...         # Optional: if not using IAM roles\nAWS_SECRET_ACCESS_KEY=...         # Optional: if not using IAM roles\n\n# Email Settings\nAWS_SES_FROM_EMAIL=noreply@talawa.io  # Required: sender email\nAWS_SES_FROM_NAME=Talawa              # Optional: sender name\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ses-provider-features",children:"SES Provider Features"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Lazy Initialization"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"AWS credentials and SES client are initialized on first email send"}),"\n",(0,r.jsx)(n.li,{children:"Validates configuration before attempting to send"}),"\n",(0,r.jsx)(n.li,{children:"Provides clear error messages for missing configuration"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Rate Limiting"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Includes 100ms delay between emails to avoid SES throttling"}),"\n",(0,r.jsx)(n.li,{children:"Prevents hitting AWS SES sending rate limits"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Error Handling"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Catches and converts AWS SDK errors to EmailResult format"}),"\n",(0,r.jsx)(n.li,{children:"Handles both Error objects and non-Error exceptions"}),"\n",(0,r.jsx)(n.li,{children:"Returns descriptive error messages for debugging"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration Validation"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Validates before sending\nif (!this.config.region) {\n  throw new Error('AWS_SES_REGION is required');\n}\n\nif (!this.config.fromEmail) {\n  throw new Error('AWS_SES_FROM_EMAIL is required');\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"smtp-provider",children:"SMTP Provider"}),"\n",(0,r.jsx)(n.p,{children:"The SMTP provider offers a vendor-neutral solution that works with any SMTP server, including:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Self-hosted servers (Postfix, Sendmail)"}),"\n",(0,r.jsx)(n.li,{children:"Popular email services (Gmail, Outlook, Yahoo)"}),"\n",(0,r.jsx)(n.li,{children:"Web hosting providers (GoDaddy, Bluehost, etc.)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"configuration-1",children:"Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Email Provider Selection\nAPI_EMAIL_PROVIDER=smtp\n\n# SMTP Server Settings\nSMTP_HOST=smtp.gmail.com          # Required: SMTP server hostname  \nSMTP_PORT=587                     # Required: SMTP port (587 for TLS, 465 for SSL)\nSMTP_SECURE=false                 # Required: true for SSL (port 465), false for TLS (port 587)\n\n# Authentication (optional if server doesn\'t require auth)\nSMTP_USER=your-email@gmail.com    # SMTP username\nSMTP_PASSWORD=your-app-password   # SMTP password\n\n# Email Settings\nSMTP_FROM_EMAIL=noreply@talawa.io # Required: sender email\nSMTP_FROM_NAME=Talawa             # Optional: sender name (default: "Talawa")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"smtp-provider-features",children:"SMTP Provider Features"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Lazy Initialization"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"SMTP transporter is initialized on first email send"}),"\n",(0,r.jsx)(n.li,{children:"Validates configuration before attempting to connect"}),"\n",(0,r.jsx)(n.li,{children:"Provides clear error messages for connection failures"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Rate Limiting"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Includes 100ms delay between emails to avoid throttling"}),"\n",(0,r.jsx)(n.li,{children:"Prevents overwhelming SMTP servers"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"TLS/SSL Support"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Configurable security mode via ",(0,r.jsx)(n.code,{children:"SMTP_SECURE"})]}),"\n",(0,r.jsx)(n.li,{children:"STARTTLS support for port 587"}),"\n",(0,r.jsx)(n.li,{children:"Direct SSL/TLS for port 465"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flexible Authentication"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Supports username/password authentication"}),"\n",(0,r.jsx)(n.li,{children:"Works without authentication if server allows"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Error Handling"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Catches and converts Nodemailer errors to EmailResult format"}),"\n",(0,r.jsx)(n.li,{children:"Returns descriptive error messages for debugging"}),"\n",(0,r.jsx)(n.li,{children:"Handles connection timeouts and authentication failures"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"common-smtp-configurations",children:"Common SMTP Configurations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Gmail"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_SECURE=false\nSMTP_USER=your-email@gmail.com\nSMTP_PASSWORD=your-app-password  # Use App Password, not regular password\nSMTP_FROM_EMAIL=your-email@gmail.com\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note"}),': Gmail requires an "App Password" if 2FA is enabled. Generate one at: ',(0,r.jsx)(n.a,{href:"https://myaccount.google.com/apppasswords",children:"https://myaccount.google.com/apppasswords"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Outlook/Office 365"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SMTP_HOST=smtp-mail.outlook.com\nSMTP_PORT=587\nSMTP_SECURE=false\nSMTP_USER=your-email@outlook.com\nSMTP_PASSWORD=your-password\nSMTP_FROM_EMAIL=your-email@outlook.com\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"GoDaddy"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SMTP_HOST=smtp.secureserver.net\nSMTP_PORT=465\nSMTP_SECURE=true\nSMTP_USER=your-email@yourdomain.com\nSMTP_PASSWORD=your-password\nSMTP_FROM_EMAIL=your-email@yourdomain.com\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Self-Hosted Postfix"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SMTP_HOST=mail.yourdomain.com\nSMTP_PORT=587\nSMTP_SECURE=false\n# Authentication may not be required for local server\n# SMTP_USER and SMTP_PASSWORD can be omitted\nSMTP_FROM_EMAIL=noreply@yourdomain.com\n"})}),"\n",(0,r.jsx)(n.h3,{id:"smtp-security-best-practices",children:"SMTP Security Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use TLS/STARTTLS"}),": Always use port 587 with ",(0,r.jsx)(n.code,{children:"SMTP_SECURE=false"})," (STARTTLS) or port 465 with ",(0,r.jsx)(n.code,{children:"SMTP_SECURE=true"})," (direct SSL)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Never use port 25"}),": Port 25 is often blocked by ISPs and lacks encryption"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use App Passwords"}),": For Gmail and other providers with 2FA, use app-specific passwords"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Secure Credentials"}),": Store SMTP credentials in environment variables, never in code"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Configuration"}),": Use the setup script (",(0,r.jsx)(n.code,{children:"npm run setup"}),") to verify SMTP settings"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"provider-comparison",children:"Provider Comparison"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Feature"}),(0,r.jsx)(n.th,{children:"AWS SES"}),(0,r.jsx)(n.th,{children:"SMTP"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Setup Complexity"})}),(0,r.jsx)(n.td,{children:"Medium (requires AWS account)"}),(0,r.jsx)(n.td,{children:"Low (works with any provider)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Cost"})}),(0,r.jsx)(n.td,{children:"Pay per email sent"}),(0,r.jsx)(n.td,{children:"Depends on hosting provider"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Vendor Lock-in"})}),(0,r.jsx)(n.td,{children:"AWS-specific"}),(0,r.jsx)(n.td,{children:"Vendor-neutral"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Reliability"})}),(0,r.jsx)(n.td,{children:"Very high (AWS infrastructure)"}),(0,r.jsx)(n.td,{children:"Depends on SMTP server"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Sending Limits"})}),(0,r.jsx)(n.td,{children:"High (50 emails/second default)"}),(0,r.jsx)(n.td,{children:"Varies by provider"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Authentication"})}),(0,r.jsx)(n.td,{children:"AWS credentials or IAM roles"}),(0,r.jsx)(n.td,{children:"Username/password"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Best For"})}),(0,r.jsx)(n.td,{children:"Production deployments, high volume"}),(0,r.jsx)(n.td,{children:"Development, self-hosted, flexible deployments"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"email-queue-system",children:"Email Queue System"}),"\n",(0,r.jsx)(n.h3,{id:"database-schema",children:"Database Schema"}),"\n",(0,r.jsxs)(n.p,{children:["Emails are stored in the ",(0,r.jsx)(n.code,{children:"email_notifications"})," table:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"{\n  id: string;              // UUID\n  userId: string | null;   // User this email is for\n  email: string;           // Recipient address\n  subject: string;         // Email subject\n  htmlBody: string;        // HTML content\n  textBody: string | null; // Plain text content\n  status: 'pending' | 'sent' | 'failed';\n  retryCount: number;      // Number of send attempts\n  maxRetries: number;      // Maximum retry attempts (default: 3)\n  sesMessageId: string | null; // SES tracking ID\n  error: string | null;    // Last error message\n  sentAt: Date | null;     // When successfully sent\n  createdAt: Date;         // When queued\n  updatedAt: Date;         // Last modification\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"queue-processing",children:"Queue Processing"}),"\n",(0,r.jsx)(n.p,{children:"The queue processor runs as a background task:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Initialization (happens on server startup)\nawait emailQueueInstance.initializeEmailQueue();\n\n// Processing cycle\n1. Fetch pending emails (status = 'pending')\n2. Send in batches using configured provider\n3. Update status based on results:\n   - Success: status='sent', store messageId, set sentAt\n   - Failure: increment retryCount, store error\n   - Max retries: status='failed'\n4. Wait for next cycle (configurable interval)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"retry-logic",children:"Retry Logic"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Exponential Backoff Strategy"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Retry delays\nAttempt 1: Immediate\nAttempt 2: After 5 minutes\nAttempt 3: After 15 minutes\nMax Retries: 3 (default, configurable per email)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Retry Example"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Email fails on first attempt\nretryCount: 0 -> 1\nnextRetryAt: current time + 5 minutes\n\n// Processor picks it up again after 5 minutes\nretryCount: 1 -> 2\nnextRetryAt: current time + 15 minutes\n\n// Fails again after 15 minutes\nretryCount: 2 -> 3\nstatus: 'pending' -> 'failed' (max retries reached)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"how-to-use-the-email-service",children:"How to Use the Email Service"}),"\n",(0,r.jsx)(n.h3,{id:"sending-a-single-email",children:"Sending a Single Email"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { emailService } from '~/src/services/email/emailServiceInstance';\n\n// Create email job\nconst emailJob: EmailJob = {\n  id: generateUUID(),\n  email: 'user@example.com',\n  subject: 'Welcome to Talawa',\n  htmlBody: '<h1>Welcome!</h1><p>Thanks for joining.</p>',\n  textBody: 'Welcome! Thanks for joining.',\n  userId: user.id,\n};\n\n// Send immediately (not queued)\nconst result = await emailService.sendEmail(emailJob);\n\nif (result.success) {\n  console.log(`Email sent: ${result.messageId}`);\n} else {\n  console.error(`Email failed: ${result.error}`);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"queuing-emails-for-background-processing",children:"Queuing Emails for Background Processing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { drizzleClient } from '~/src/fastifyPlugins/drizzleClient';\nimport { emailNotificationsTable } from '~/src/db/schema/emailNotifications.drizzle';\n\n// Insert email into queue\nawait drizzleClient.insert(emailNotificationsTable).values({\n  id: generateUUID(),\n  userId: user.id,\n  email: 'user@example.com',\n  subject: 'Password Reset',\n  htmlBody: resetEmailHtml,\n  textBody: resetEmailText,\n  status: 'pending',\n  retryCount: 0,\n  maxRetries: 3,\n  createdAt: new Date(),\n  updatedAt: new Date(),\n});\n\n// Background processor will send it automatically\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sending-bulk-emails",children:"Sending Bulk Emails"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { emailService } from '~/src/services/email/emailServiceInstance';\n\nconst emailJobs: EmailJob[] = users.map(user => ({\n  id: generateUUID(),\n  email: user.email,\n  subject: 'Event Reminder',\n  htmlBody: generateEventEmailHtml(user, event),\n  userId: user.id,\n}));\n\n// Send all emails\nconst results = await emailService.sendBulkEmails(emailJobs);\n\n// Check results\nconst successful = results.filter(r => r.success).length;\nconst failed = results.filter(r => !r.success).length;\nconsole.log(`Sent: ${successful}, Failed: ${failed}`);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"adding-a-new-email-provider",children:"Adding a New Email Provider"}),"\n",(0,r.jsx)(n.p,{children:"To add support for a new provider (e.g., SMTP, SendGrid, Mailgun):"}),"\n",(0,r.jsx)(n.h3,{id:"step-1-create-provider-implementation",children:"Step 1: Create Provider Implementation"}),"\n",(0,r.jsxs)(n.p,{children:["Create a new file ",(0,r.jsx)(n.code,{children:"src/services/email/providers/YourProvider.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import type { IEmailProvider, EmailJob, EmailResult } from '../types';\n\nexport interface YourProviderConfig {\n  // Provider-specific configuration\n  apiKey: string;\n  apiUrl?: string;\n}\n\nexport class YourProvider implements IEmailProvider {\n  private config: YourProviderConfig;\n\n  constructor(config: YourProviderConfig) {\n    this.config = config;\n  }\n\n  async sendEmail(job: EmailJob): Promise<EmailResult> {\n    try {\n      // Validate configuration\n      if (!this.config.apiKey) {\n        throw new Error('API_KEY is required for YourProvider');\n      }\n\n      // Send using provider's API\n      const response = await yourProviderSdk.send({\n        to: job.email,\n        subject: job.subject,\n        html: job.htmlBody,\n        text: job.textBody,\n      });\n\n      return {\n        id: job.id,\n        success: true,\n        messageId: response.messageId,\n      };\n    } catch (error) {\n      return {\n        id: job.id,\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n      };\n    }\n  }\n\n  async sendBulkEmails(jobs: EmailJob[]): Promise<EmailResult[]> {\n    const results: EmailResult[] = [];\n    \n    for (const job of jobs) {\n      results.push(await this.sendEmail(job));\n    }\n    \n    return results;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-2-update-factory",children:"Step 2: Update Factory"}),"\n",(0,r.jsxs)(n.p,{children:["Update ",(0,r.jsx)(n.code,{children:"src/services/email/EmailProviderFactory.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { YourProvider } from './providers/YourProvider';\n\nexport const EmailProviderFactory = {\n  create(config: EmailEnvConfig): IEmailProvider {\n    switch (config.emailProvider) {\n      case 'ses':\n        return new SESProvider({\n          region: config.awsSesRegion,\n          // ... SES config\n        });\n\n      case 'yourprovider':\n        return new YourProvider({\n          apiKey: config.yourProviderApiKey,\n          // ... Your provider config\n        });\n\n      default:\n        throw new Error(`Unsupported email provider: ${config.emailProvider}`);\n    }\n  },\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-3-update-environment-schema",children:"Step 3: Update Environment Schema"}),"\n",(0,r.jsxs)(n.p,{children:["Update ",(0,r.jsx)(n.code,{children:"src/envConfigSchema.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"API_EMAIL_PROVIDER: z\n  .enum(['ses', 'smtp', 'yourprovider'])\n  .default('ses')\n  .optional(),\n\n// Add provider-specific config\nYOUR_PROVIDER_API_KEY: z.string().optional(),\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-4-add-tests",children:"Step 4: Add Tests"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"test/services/email/YourProvider.test.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { describe, it, expect, vi } from 'vitest';\nimport { YourProvider } from '~/src/services/email/providers/YourProvider';\n\ndescribe('YourProvider', () => {\n  it('should send email successfully', async () => {\n    const provider = new YourProvider({ apiKey: 'test-key' });\n    \n    const job = {\n      id: '1',\n      email: 'test@example.com',\n      subject: 'Test',\n      htmlBody: '<p>Test</p>',\n      userId: 'user1',\n    };\n\n    const result = await provider.sendEmail(job);\n    \n    expect(result.success).toBe(true);\n    expect(result.messageId).toBeDefined();\n  });\n\n  it('should handle errors gracefully', async () => {\n    const provider = new YourProvider({ apiKey: '' });\n    \n    const job = {\n      id: '1',\n      email: 'test@example.com',\n      subject: 'Test',\n      htmlBody: '<p>Test</p>',\n      userId: 'user1',\n    };\n\n    const result = await provider.sendEmail(job);\n    \n    expect(result.success).toBe(false);\n    expect(result.error).toBeDefined();\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-5-update-documentation",children:"Step 5: Update Documentation"}),"\n",(0,r.jsx)(n.p,{children:"Update this file and the configuration documentation with your new provider's settings."}),"\n",(0,r.jsx)(n.h2,{id:"configuration-reference",children:"Configuration Reference"}),"\n",(0,r.jsx)(n.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Required for Any Provider"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"API_EMAIL_PROVIDER=ses              # Provider to use ('ses' or 'smtp')\nAPI_ENABLE_EMAIL_QUEUE=true         # Enable background queue\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"AWS SES Provider"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"AWS_SES_REGION=us-east-1            # AWS region\nAWS_SES_FROM_EMAIL=noreply@talawa.io # Sender email (required)\nAWS_SES_FROM_NAME=Talawa            # Sender name (optional)\n\n# Optional: if not using IAM roles\nAWS_ACCESS_KEY_ID=AKIA...\nAWS_SECRET_ACCESS_KEY=...\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SMTP Provider"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SMTP_HOST=smtp.example.com          # SMTP server hostname (required)\nSMTP_PORT=587                       # SMTP port (required)\nSMTP_SECURE=false                   # Use SSL/TLS (required)\nSMTP_USER=user@example.com          # SMTP username (optional)\nSMTP_PASSWORD=password              # SMTP password (optional)\nSMTP_FROM_EMAIL=noreply@talawa.io   # Sender email (required)\nSMTP_FROM_NAME=Talawa               # Sender name (optional)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Queue Processing"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"EMAIL_QUEUE_INTERVAL=60000          # Processing interval in ms (default: 60s)\nEMAIL_MAX_RETRIES=3                 # Max retry attempts per email\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-validation",children:"Configuration Validation"}),"\n",(0,r.jsx)(n.p,{children:"The system validates configuration on startup:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// In EmailProviderFactory\nif (!config.awsSesRegion) {\n  throw new Error('AWS_SES_REGION is required when using SES provider');\n}\n\n// Provider-specific validation in each provider's constructor\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"email-not-sending",children:"Email Not Sending"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check queue status:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Query pending emails\nconst pending = await drizzleClient.query.emailNotificationsTable.findMany({\n  where: eq(emailNotificationsTable.status, 'pending'),\n});\n\nconsole.log(`Pending emails: ${pending.length}`);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check queue processor:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Verify queue is running\nconst isRunning = emailQueueInstance.isQueueRunning();\nconsole.log(`Queue running: ${isRunning}`);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check failed emails:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Query failed emails\nconst failed = await drizzleClient.query.emailNotificationsTable.findMany({\n  where: eq(emailNotificationsTable.status, 'failed'),\n  orderBy: desc(emailNotificationsTable.updatedAt),\n  limit: 10,\n});\n\n// Review error messages\nfailed.forEach(email => {\n  console.log(`Email ${email.id}: ${email.error}`);\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"aws-ses-issues",children:"AWS SES Issues"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Verify SES region:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Check if region is accessible\naws ses get-send-quota --region us-east-1\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Verify from email:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# List verified email identities\naws ses list-verified-email-addresses --region us-east-1\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check SES limits:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# View sending quota\naws ses get-send-quota --region us-east-1\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Common SES errors:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'"Email address not verified"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify the sender email in AWS SES console"}),"\n",(0,r.jsxs)(n.li,{children:["See: ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/ses/latest/dg/verify-email-addresses.html",children:"https://docs.aws.amazon.com/ses/latest/dg/verify-email-addresses.html"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'"Daily sending quota exceeded"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Check your SES sending limits"}),"\n",(0,r.jsx)(n.li,{children:"Request limit increase if needed"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'"Message rejected: Email address is not verified"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"In sandbox mode, verify both sender and recipient"}),"\n",(0,r.jsx)(n.li,{children:"Request production access for SES"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"smtp-issues",children:"SMTP Issues"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Connection refused:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check firewall settings:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure outbound connections to SMTP port are allowed"}),"\n",(0,r.jsx)(n.li,{children:"Common ports: 587 (TLS), 465 (SSL)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Verify SMTP host and port:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Test SMTP connection\ntelnet smtp.example.com 587\n# or\nopenssl s_client -connect smtp.example.com:465 -crlf\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check SMTP server status:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify your email provider's status page"}),"\n",(0,r.jsx)(n.li,{children:"Some providers block SMTP by default (requires enabling)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Authentication failed:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Verify credentials:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Double-check SMTP_USER and SMTP_PASSWORD"}),"\n",(0,r.jsx)(n.li,{children:"For Gmail, use App Password (not regular password)"}),"\n",(0,r.jsx)(n.li,{children:"For Office 365, ensure account allows SMTP access"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check authentication requirements:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Some servers don't require auth\n// Omit SMTP_USER and SMTP_PASSWORD if not needed\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SSL/TLS errors:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use correct SMTP_SECURE setting:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Port 587: ",(0,r.jsx)(n.code,{children:"SMTP_SECURE=false"})," (uses STARTTLS)"]}),"\n",(0,r.jsxs)(n.li,{children:["Port 465: ",(0,r.jsx)(n.code,{children:"SMTP_SECURE=true"})," (direct SSL/TLS)"]}),"\n",(0,r.jsx)(n.li,{children:"Never use port 25 (unencrypted)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Certificate issues:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure system time is correct"}),"\n",(0,r.jsx)(n.li,{children:"Update system CA certificates"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Common SMTP Provider Issues:"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Gmail:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'Enable "Less secure app access" (if not using App Password)'}),"\n",(0,r.jsxs)(n.li,{children:["Generate App Password: ",(0,r.jsx)(n.a,{href:"https://myaccount.google.com/apppasswords",children:"https://myaccount.google.com/apppasswords"})]}),"\n",(0,r.jsx)(n.li,{children:'Check for "suspicious activity" blocks in Gmail account'}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Outlook/Office 365:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Enable SMTP AUTH in  Exchange admin center"}),"\n",(0,r.jsx)(n.li,{children:"Check if account requires multi-factor authentication"}),"\n",(0,r.jsx)(n.li,{children:"Verify account isn't suspended or limited"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"GoDaddy:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure email hosting is active"}),"\n",(0,r.jsx)(n.li,{children:"Use workspace email credentials (not cPanel login)"}),"\n",(0,r.jsx)(n.li,{children:"Check if SMTP relay is enabled for your plan"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Self-Hosted:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify Postfix/Sendmail is running: ",(0,r.jsx)(n.code,{children:"sudo systemctl status postfix"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check mail logs: ",(0,r.jsx)(n.code,{children:"sudo tail -f /var/log/mail.log"})]}),"\n",(0,r.jsx)(n.li,{children:"Ensure DNS records (SPF, DKIM, DMARC) are configured"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"queue-processor-issues",children:"Queue Processor Issues"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Queue not processing:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Check if queue is enabled:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"API_ENABLE_EMAIL_QUEUE=true\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Check server logs for initialization errors:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'"Email queue processor initialized"\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Verify database connectivity:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Test database connection\nawait drizzleClient.select().from(emailNotificationsTable).limit(1);\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Emails stuck in pending:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Check retry count:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT id, retryCount, error FROM email_notifications WHERE status = 'pending';\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Reset retry count if needed:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await drizzleClient\n  .update(emailNotificationsTable)\n  .set({ retryCount: 0, updatedAt: new Date() })\n  .where(eq(emailNotificationsTable.id, emailId));\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"1-always-queue-non-critical-emails",children:"1. Always Queue Non-Critical Emails"}),"\n",(0,r.jsx)(n.p,{children:"Queue emails that don't need immediate delivery:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// GOOD - Queue welcome emails\nawait insertIntoQueue({\n  email: user.email,\n  subject: 'Welcome to Talawa',\n  htmlBody: welcomeEmail,\n});\n\n// GOOD - Send critical emails immediately\nconst result = await emailService.sendEmail({\n  email: user.email,\n  subject: 'Password Reset Code',\n  htmlBody: resetCode,\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-always-provide-plain-text-alternative",children:"2. Always Provide Plain Text Alternative"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// GOOD - Provide both HTML and plain text\n{\n  htmlBody: '<h1>Welcome</h1><p>Thanks for joining!</p>',\n  textBody: 'Welcome\\n\\nThanks for joining!',\n}\n\n// BAD - HTML only\n{\n  htmlBody: '<h1>Welcome</h1><p>Thanks for joining!</p>',\n  // textBody missing - email clients may mark as spam\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-use-descriptive-subjects",children:"3. Use Descriptive Subjects"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// GOOD\nsubject: 'Your Talawa Password Reset Link'\n\n// BAD - Too generic\nsubject: 'Reset Password'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-handle-send-failures-gracefully",children:"4. Handle Send Failures Gracefully"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const result = await emailService.sendEmail(job);\n\nif (!result.success) {\n  // Log for debugging\n  logger.error('Email send failed', {\n    emailId: job.id,\n    error: result.error,\n  });\n  \n  // Don't fail the entire operation\n  // Return appropriate error to user\n  return {\n    success: true,\n    message: 'Account created. If you don\\'t receive the email, check spam folder.',\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"5-respect-user-preferences",children:"5. Respect User Preferences"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Check if user wants email notifications\nconst user = await getUserById(userId);\n\nif (user.emailNotificationsEnabled) {\n  await queueEmail({ email: user.email, ... });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"6-rate-limit-bulk-operations",children:"6. Rate Limit Bulk Operations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// GOOD - Batch emails to avoid overwhelming the queue\nconst batches = chunk(users, 100); // Process 100 at a time\n\nfor (const batch of batches) {\n  const jobs = batch.map(user => createEmailJob(user));\n  await emailService.sendBulkEmails(jobs);\n  \n  // Optional: delay between batches\n  await sleep(1000);\n}\n\n// BAD - Queue 10,000 emails at once\nawait Promise.all(users.map(user => queueEmail(user)));\n"})}),"\n",(0,r.jsx)(n.h3,{id:"7-test-email-templates",children:"7. Test Email Templates"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Create helper for testing email templates\nexport function previewEmail(template: string, data: any): string {\n  const html = renderTemplate(template, data);\n  \n  // Save to file for browser preview\n  fs.writeFileSync('/tmp/email-preview.html', html);\n  \n  return html;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"8-monitor-email-metrics",children:"8. Monitor Email Metrics"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Track email delivery metrics\nconst metrics = {\n  sent: await countByStatus('sent'),\n  failed: await countByStatus('failed'),\n  pending: await countByStatus('pending'),\n  retrying: await countRetrying(),\n};\n\nlogger.info('Email metrics', metrics);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(n.h3,{id:"unit-testing-email-providers",children:"Unit Testing Email Providers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { describe, it, expect, vi } from 'vitest';\n\ndescribe('SESProvider', () => {\n  it('should send email successfully', async () => {\n    // Mock AWS SDK\n    const mockSend = vi.fn().mockResolvedValue({ MessageId: 'msg-123' });\n    vi.mocked(SESClient).prototype.send = mockSend;\n\n    const provider = new SESProvider({ region: 'us-east-1', ... });\n    const result = await provider.sendEmail(testJob);\n\n    expect(result.success).toBe(true);\n    expect(result.messageId).toBe('msg-123');\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"integration-testing-queue",children:"Integration Testing Queue"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"describe('Email Queue Integration', () => {\n  it('should process queued emails', async () => {\n    // Insert test email\n    await drizzleClient.insert(emailNotificationsTable).values({\n      id: 'test-1',\n      email: 'test@example.com',\n      subject: 'Test',\n      htmlBody: '<p>Test</p>',\n      status: 'pending',\n    });\n\n    // Process queue\n    await emailQueueProcessor.processPendingEmails();\n\n    // Verify sent\n    const email = await getEmailById('test-1');\n    expect(email.status).toBe('sent');\n    expect(email.sesMessageId).toBeDefined();\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"testing-email-templates",children:"Testing Email Templates"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"describe('Email Templates', () => {\n  it('should render welcome email correctly', () => {\n    const html = renderWelcomeEmail({\n      firstName: 'John',\n      organizationName: 'Test Org',\n    });\n\n    expect(html).toContain('Welcome, John!');\n    expect(html).toContain('Test Org');\n    expect(html).toMatch(/<html/);\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"future-improvements",children:"Future Improvements"}),"\n",(0,r.jsx)(n.h3,{id:"planned-features",children:"Planned Features"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Additional Email Providers"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"SendGrid integration"}),"\n",(0,r.jsx)(n.li,{children:"Mailgun integration"}),"\n",(0,r.jsx)(n.li,{children:"Resend integration"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Email Templates System"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Template engine integration (Handlebars/Mustache)"}),"\n",(0,r.jsx)(n.li,{children:"Reusable email components"}),"\n",(0,r.jsx)(n.li,{children:"Multi-language support"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Email Analytics"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Open tracking"}),"\n",(0,r.jsx)(n.li,{children:"Click tracking"}),"\n",(0,r.jsx)(n.li,{children:"Bounce handling"}),"\n",(0,r.jsx)(n.li,{children:"Delivery reports"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Enhanced Queue Management"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Priority queues"}),"\n",(0,r.jsx)(n.li,{children:"Scheduled send times"}),"\n",(0,r.jsx)(n.li,{children:"Batch processing optimization"}),"\n",(0,r.jsx)(n.li,{children:"Dead letter queue for permanently failed emails"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Email Attachments"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Support for file attachments"}),"\n",(0,r.jsx)(n.li,{children:"Inline images"}),"\n",(0,r.jsx)(n.li,{children:"Size limits and validation"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:"The Talawa API email service provides a flexible, reliable system for sending emails using a provider-agnostic architecture. With support for both AWS SES and SMTP, you can choose the solution that best fits your deployment needs. The queue-based processing with automatic retries ensures reliable delivery, while the Strategy Pattern makes it easy to add new providers in the future."}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Advanced Queue Features"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Priority queue (send important emails first)"}),"\n",(0,r.jsx)(n.li,{children:"Scheduled sends (send at specific time)"}),"\n",(0,r.jsx)(n.li,{children:"Batch optimization"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Batch Processing Improvement"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Current: Sequential sending\nfor (const job of jobs) {\n  results.push(await sendEmail(job));\n}\n\n// Future: Parallel batch sending (AWS SES supports batch API)\nconst sesResults = await sesClient.sendBulkTemplatedEmail({\n  Destinations: jobs.map(j => ({ Destination: { ToAddresses: [j.email] } })),\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/developer-resources/error-handling-guide",children:"Error Handling Guide"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/developer-resources/authentication-authorization-guide",children:"Authentication Guide"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/ses/",children:"AWS SES Documentation"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://refactoring.guru/design-patterns/strategy",children:"Strategy Pattern (Design Patterns)"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"summary-1",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:"The Talawa API email service provides:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Flexibility:"})," Easy to add new email providers via Strategy Pattern"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reliability:"})," Automatic retry with exponential backoff"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Scalability:"})," Asynchronous queue for background processing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Maintainability:"})," Clear separation of concerns and comprehensive tests"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Observability:"})," Database-backed queue with status tracking"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When working with emails:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use the queue for non-critical emails"}),"\n",(0,r.jsx)(n.li,{children:"Always provide plain text alternatives"}),"\n",(0,r.jsx)(n.li,{children:"Handle failures gracefully"}),"\n",(0,r.jsx)(n.li,{children:"Test email templates thoroughly"}),"\n",(0,r.jsx)(n.li,{children:"Monitor queue health and metrics"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"For questions or issues, refer to the troubleshooting section or consult the test files for working examples."})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);