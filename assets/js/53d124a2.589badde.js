"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[40925],{55288:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(30758);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}},81735:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"docs/developer-resources/best-practices/authentication-authorization-guide","title":"Authentication and Authorization Guide","description":"This document outlines the authentication and authorization architecture and best practices in the Talawa API codebase.","source":"@site/docs/docs/developer-resources/best-practices/authentication-authorization.md","sourceDirName":"docs/developer-resources/best-practices","slug":"/developer-resources/authentication-authorization-guide","permalink":"/docs/developer-resources/authentication-authorization-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/PalisadoesFoundation/talawa-api/edit/develop/docs/docs/docs/developer-resources/best-practices/authentication-authorization.md","tags":[],"version":"current","sidebarPosition":85,"frontMatter":{"id":"authentication-authorization-guide","title":"Authentication and Authorization Guide","slug":"/developer-resources/authentication-authorization-guide","sidebar_position":85},"sidebar":"tutorialSidebar","previous":{"title":"Error Handling Guide","permalink":"/docs/developer-resources/error-handling-guide"},"next":{"title":"Logging Guide","permalink":"/docs/developer-resources/logging-guide"}}');var i=t(86070),s=t(55288);const a={id:"authentication-authorization-guide",title:"Authentication and Authorization Guide",slug:"/developer-resources/authentication-authorization-guide",sidebar_position:85},o=void 0,c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Core Concepts",id:"core-concepts",level:2},{value:"Authentication vs Authorization",id:"authentication-vs-authorization",level:3},{value:"Authentication Architecture",id:"authentication-architecture",level:2},{value:"JWT Token System",id:"jwt-token-system",level:3},{value:"Token Structure",id:"token-structure",level:4},{value:"Token Generation",id:"token-generation",level:4},{value:"Token Verification",id:"token-verification",level:4},{value:"Token Versioning",id:"token-versioning",level:3},{value:"Authentication Flow",id:"authentication-flow",level:3},{value:"Authorization Architecture",id:"authorization-architecture",level:2},{value:"Role-Based Access Control (RBAC)",id:"role-based-access-control-rbac",level:3},{value:"Role Definitions",id:"role-definitions",level:3},{value:"Authorization Utilities",id:"authorization-utilities",level:3},{value:"Checking User Authentication",id:"checking-user-authentication",level:4},{value:"Checking Organization Admin",id:"checking-organization-admin",level:4},{value:"Checking Superadmin",id:"checking-superadmin",level:4},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Verify Authentication First",id:"1-always-verify-authentication-first",level:3},{value:"2. Check Authorization Before Data Access",id:"2-check-authorization-before-data-access",level:3},{value:"3. Use Field-Level Authorization for Sensitive Data",id:"3-use-field-level-authorization-for-sensitive-data",level:3},{value:"4. Validate Token on Every Request",id:"4-validate-token-on-every-request",level:3},{value:"5. Handle Authorization Errors Properly",id:"5-handle-authorization-errors-properly",level:3},{value:"6. Secure Token Storage",id:"6-secure-token-storage",level:3},{value:"7. Rate Limit Authentication Attempts",id:"7-rate-limit-authentication-attempts",level:3},{value:"8. Implement Password Security",id:"8-implement-password-security",level:3},{value:"9. Audit Sensitive Operations",id:"9-audit-sensitive-operations",level:3},{value:"10. Use Middleware for Common Checks",id:"10-use-middleware-for-common-checks",level:3},{value:"Common Authorization Patterns",id:"common-authorization-patterns",level:2},{value:"Pattern 1: Resource Ownership Check",id:"pattern-1-resource-ownership-check",level:3},{value:"Pattern 2: Organization Membership Check",id:"pattern-2-organization-membership-check",level:3},{value:"Pattern 3: Hierarchical Permission Check",id:"pattern-3-hierarchical-permission-check",level:3},{value:"Security Checklist",id:"security-checklist",level:2},{value:"Testing Authorization",id:"testing-authorization",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"Integration Tests",id:"integration-tests",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Common Pitfalls",id:"common-pitfalls",level:2},{value:"1. Not Checking Authentication",id:"1-not-checking-authentication",level:3},{value:"2. Trusting Client-Provided User IDs",id:"2-trusting-client-provided-user-ids",level:3},{value:"3. Forgetting to Check Token Version",id:"3-forgetting-to-check-token-version",level:3},{value:"4. Exposing Sensitive Data in Errors",id:"4-exposing-sensitive-data-in-errors",level:3},{value:"Further Reading",id:"further-reading",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This document outlines the authentication and authorization architecture and best practices in the Talawa API codebase."}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"Authentication and authorization are critical security components that control who can access the API and what actions they can perform. This guide explains how Talawa API implements these security mechanisms using JWT tokens, role-based access control, and GraphQL context."}),"\n",(0,i.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,i.jsx)(n.h3,{id:"authentication-vs-authorization",children:"Authentication vs Authorization"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Authentication"}),' answers: "Who are you?"']}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Verifies the identity of a user"}),"\n",(0,i.jsx)(n.li,{children:"Implemented using JWT (JSON Web Tokens)"}),"\n",(0,i.jsx)(n.li,{children:"Handles login, token generation, and token validation"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Authorization"}),' answers: "What can you do?"']}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Determines what an authenticated user is allowed to do"}),"\n",(0,i.jsx)(n.li,{children:"Implemented using role-based access control (RBAC)"}),"\n",(0,i.jsx)(n.li,{children:"Checks permissions before allowing operations"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"authentication-architecture",children:"Authentication Architecture"}),"\n",(0,i.jsx)(n.h3,{id:"jwt-token-system",children:"JWT Token System"}),"\n",(0,i.jsx)(n.p,{children:"Talawa API uses a dual-token system for authentication:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Access Token"}),": Short-lived JWT token for API requests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Refresh Token"}),": Long-lived token for obtaining new access tokens"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"token-structure",children:"Token Structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface JWTPayload {\n  userId: string;\n  tokenVersion: number;\n  iat: number;  // Issued at\n  exp: number;  // Expiration time\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"token-generation",children:"Token Generation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import jwt from 'jsonwebtoken';\n\n// Generate access token (expires in 15 minutes)\nconst accessToken = jwt.sign(\n  { userId: user._id, tokenVersion: user.tokenVersion },\n  process.env.ACCESS_TOKEN_SECRET,\n  { expiresIn: '15m' }\n);\n\n// Generate refresh token (expires in 7 days)\nconst refreshToken = jwt.sign(\n  { userId: user._id, tokenVersion: user.tokenVersion },\n  process.env.REFRESH_TOKEN_SECRET,\n  { expiresIn: '7d' }\n);\n"})}),"\n",(0,i.jsx)(n.h4,{id:"token-verification",children:"Token Verification"}),"\n",(0,i.jsx)(n.p,{children:"All protected GraphQL operations verify the access token:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { verify } from 'jsonwebtoken';\n\n// In context creation\nconst token = request.headers.authorization?.replace('Bearer ', '');\n\nif (token) {\n  try {\n    const payload = verify(token, process.env.ACCESS_TOKEN_SECRET);\n    context.userId = payload.userId;\n  } catch (error) {\n    // Token invalid or expired\n    context.userId = null;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"token-versioning",children:"Token Versioning"}),"\n",(0,i.jsx)(n.p,{children:"Token versioning allows immediate invalidation of all user tokens:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// When user changes password or requests logout from all devices\nawait drizzleClient\n  .update(usersTable)\n  .set({ \n    tokenVersion: sql`${usersTable.tokenVersion} + 1`,\n    updatedAt: new Date()\n  })\n  .where(eq(usersTable.id, userId));\n\n// All existing tokens become invalid immediately\n"})}),"\n",(0,i.jsx)(n.h3,{id:"authentication-flow",children:"Authentication Flow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"1. User Login\n   \u2514\u2500> Client sends credentials (email + password)\n   \u2514\u2500> Server verifies credentials\n   \u2514\u2500> Server generates access + refresh tokens\n   \u2514\u2500> Server returns tokens + user data\n\n2. Authenticated Request\n   \u2514\u2500> Client includes access token in Authorization header\n   \u2514\u2500> Server verifies token in context creation\n   \u2514\u2500> Server attaches userId to context\n   \u2514\u2500> Resolver has access to authenticated user\n\n3. Token Refresh\n   \u2514\u2500> Access token expires\n   \u2514\u2500> Client sends refresh token\n   \u2514\u2500> Server verifies refresh token\n   \u2514\u2500> Server generates new access token\n   \u2514\u2500> Client continues with new token\n"})}),"\n",(0,i.jsx)(n.h2,{id:"authorization-architecture",children:"Authorization Architecture"}),"\n",(0,i.jsx)(n.h3,{id:"role-based-access-control-rbac",children:"Role-Based Access Control (RBAC)"}),"\n",(0,i.jsx)(n.p,{children:"Talawa implements a hierarchical role system:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"SUPERADMIN (Global)\n    |\n    \u2514\u2500> ADMIN (Organization-level)\n            |\n            \u251c\u2500> USER (Organization member)\n            \u2514\u2500> BLOCKED (Restricted user)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"role-definitions",children:"Role Definitions"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// User roles within an organization\nenum UserRole {\n  SUPERADMIN = 'SUPERADMIN',  // Platform-wide administrator\n  ADMIN = 'ADMIN',            // Organization administrator\n  USER = 'USER',              // Regular organization member\n  BLOCKED = 'BLOCKED'         // Blocked from organization\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"authorization-utilities",children:"Authorization Utilities"}),"\n",(0,i.jsx)(n.h4,{id:"checking-user-authentication",children:"Checking User Authentication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { assertUserAuthenticated } from '~/src/utilities/authorization';\n\n// In resolver\nexport const myMutation = async (parent, args, context) => {\n  // Throws error if user is not authenticated\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Continue with authenticated user\n};\n"})}),"\n",(0,i.jsx)(n.h4,{id:"checking-organization-admin",children:"Checking Organization Admin"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { assertOrganizationAdmin } from '~/src/utilities/authorization';\n\n// In resolver\nexport const updateOrganization = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Throws error if user is not an admin of the organization\n  await assertOrganizationAdmin(\n    currentUser,\n    args.organizationId,\n    context.drizzleClient\n  );\n  \n  // User is verified as organization admin\n};\n"})}),"\n",(0,i.jsx)(n.h4,{id:"checking-superadmin",children:"Checking Superadmin"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { assertSuperAdmin } from '~/src/utilities/authorization';\n\n// In resolver\nexport const deletePlatformUser = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Throws error if user is not a superadmin\n  assertSuperAdmin(currentUser);\n  \n  // User is verified as superadmin\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-always-verify-authentication-first",children:"1. Always Verify Authentication First"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// GOOD\nexport const createEvent = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Now we know user is authenticated\n  const event = await createEventLogic(currentUser, args);\n  return event;\n};\n\n// BAD - No authentication check\nexport const createEvent = async (parent, args, context) => {\n  // Anyone can create events!\n  const event = await createEventLogic(context.userId, args);\n  return event;\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-check-authorization-before-data-access",children:"2. Check Authorization Before Data Access"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// GOOD\nexport const viewPrivateData = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Check if user can view this data\n  const resource = await getResource(args.id);\n  if (resource.ownerId !== currentUser._id) {\n    throw new Error('Unauthorized');\n  }\n  \n  return resource;\n};\n\n// BAD - Returns data before checking ownership\nexport const viewPrivateData = async (parent, args, context) => {\n  return await getResource(args.id);\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-use-field-level-authorization-for-sensitive-data",children:"3. Use Field-Level Authorization for Sensitive Data"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// In GraphQL resolvers\nconst User = {\n  email: (parent, args, context) => {\n    const currentUser = assertUserAuthenticated(context);\n    \n    // Only show email to the user themselves or admins\n    if (parent._id !== currentUser._id && !currentUser.isSuperAdmin) {\n      return '********'; // Masked email\n    }\n    \n    return parent.email;\n  },\n  \n  phoneNumber: (parent, args, context) => {\n    // Similar authorization for phone numbers\n    const currentUser = assertUserAuthenticated(context);\n    \n    if (parent._id !== currentUser._id) {\n      return null; // Hide phone number\n    }\n    \n    return parent.phoneNumber;\n  }\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-validate-token-on-every-request",children:"4. Validate Token on Every Request"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// In context creation (src/routes/graphql.ts)\nexport const createContext = async (request, reply) => {\n  const token = request.headers.authorization?.replace('Bearer ', '');\n  \n  let userId = null;\n  \n  if (token) {\n    try {\n      const payload = verify(token, process.env.ACCESS_TOKEN_SECRET);\n      \n      // Verify token version matches database\n      const user = await getUserById(payload.userId);\n      if (user && user.tokenVersion === payload.tokenVersion) {\n        userId = user._id;\n      }\n    } catch (error) {\n      // Invalid token - userId remains null\n      logger.warn('Invalid token provided');\n    }\n  }\n  \n  return {\n    userId,\n    drizzleClient,\n    // ... other context properties\n  };\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-handle-authorization-errors-properly",children:"5. Handle Authorization Errors Properly"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Use descriptive error messages\nif (!isAuthorized) {\n  throw new Error('You do not have permission to perform this action');\n}\n\n// Or use custom error types\nclass UnauthorizedError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'UnauthorizedError';\n  }\n}\n\nthrow new UnauthorizedError('Admin privileges required');\n"})}),"\n",(0,i.jsx)(n.h3,{id:"6-secure-token-storage",children:"6. Secure Token Storage"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Client-side recommendations:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Store access tokens in memory (React state/Redux)"}),"\n",(0,i.jsx)(n.li,{children:"Store refresh tokens in httpOnly cookies (not accessible via JavaScript)"}),"\n",(0,i.jsx)(n.li,{children:"Never store tokens in localStorage (vulnerable to XSS attacks)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Server-side:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Set httpOnly cookie for refresh token\nreply.setCookie('refreshToken', refreshToken, {\n  httpOnly: true,\n  secure: process.env.NODE_ENV === 'production',\n  sameSite: 'strict',\n  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"7-rate-limit-authentication-attempts",children:"7. Rate Limit Authentication Attempts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Prevent brute force attacks\nimport rateLimit from '@fastify/rate-limit';\n\nfastify.register(rateLimit, {\n  max: 5, // Maximum 5 requests\n  timeWindow: '15 minutes',\n  errorResponseBuilder: (request, context) => ({\n    statusCode: 429,\n    error: 'Too Many Requests',\n    message: 'Rate limit exceeded. Try again later.',\n  }),\n  routes: ['/graphql'] // Apply to specific routes\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"8-implement-password-security",children:"8. Implement Password Security"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import bcrypt from 'bcryptjs';\n\n// Hash passwords before storing\nconst hashedPassword = await bcrypt.hash(password, 12);\n\n// Verify passwords during login\nconst isValid = await bcrypt.compare(providedPassword, storedHash);\n\n// Password requirements\nconst PASSWORD_MIN_LENGTH = 8;\nconst PASSWORD_REGEX = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/;\n\nfunction validatePassword(password: string): boolean {\n  return (\n    password.length >= PASSWORD_MIN_LENGTH &&\n    PASSWORD_REGEX.test(password)\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"9-audit-sensitive-operations",children:"9. Audit Sensitive Operations"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Log important security events\nexport const deleteUser = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  assertSuperAdmin(currentUser);\n  \n  // Log the action\n  logger.info({\n    action: 'USER_DELETED',\n    performedBy: currentUser._id,\n    targetUser: args.userId,\n    timestamp: new Date(),\n  });\n  \n  await deleteUserFromDatabase(args.userId);\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"10-use-middleware-for-common-checks",children:"10. Use Middleware for Common Checks"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Create reusable middleware\nconst requireAuth = (resolver) => {\n  return (parent, args, context, info) => {\n    assertUserAuthenticated(context);\n    return resolver(parent, args, context, info);\n  };\n};\n\nconst requireAdmin = (resolver) => {\n  return async (parent, args, context, info) => {\n    const currentUser = assertUserAuthenticated(context);\n    await assertOrganizationAdmin(\n      currentUser,\n      args.organizationId,\n      context.drizzleClient\n    );\n    return resolver(parent, args, context, info);\n  };\n};\n\n// Use in resolvers\nexport const Mutation = {\n  createEvent: requireAuth(createEventResolver),\n  updateOrganization: requireAdmin(updateOrganizationResolver),\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"common-authorization-patterns",children:"Common Authorization Patterns"}),"\n",(0,i.jsx)(n.h3,{id:"pattern-1-resource-ownership-check",children:"Pattern 1: Resource Ownership Check"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Check if user owns the resource\nexport const deletePost = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  const post = await context.drizzleClient.query.postsTable.findFirst({\n    where: eq(postsTable.id, args.postId)\n  });\n  \n  if (!post) {\n    throw new Error('Post not found');\n  }\n  \n  if (post.creatorId !== currentUser._id) {\n    throw new Error('You can only delete your own posts');\n  }\n  \n  await context.drizzleClient\n    .delete(postsTable)\n    .where(eq(postsTable.id, args.postId));\n    \n  return { success: true };\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"pattern-2-organization-membership-check",children:"Pattern 2: Organization Membership Check"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Check if user is member of organization\nexport const viewOrganizationData = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  const membership = await context.drizzleClient.query.organizationMemberships.findFirst({\n    where: and(\n      eq(organizationMemberships.userId, currentUser._id),\n      eq(organizationMemberships.organizationId, args.organizationId),\n      ne(organizationMemberships.role, 'BLOCKED')\n    )\n  });\n  \n  if (!membership) {\n    throw new Error('You are not a member of this organization');\n  }\n  \n  // Proceed with operation\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"pattern-3-hierarchical-permission-check",children:"Pattern 3: Hierarchical Permission Check"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Superadmins can do anything, admins can manage their org, users can manage their own data\nexport const updateUserProfile = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  \n  // Superadmin can update anyone\n  if (currentUser.isSuperAdmin) {\n    return updateUser(args.userId, args.updates);\n  }\n  \n  // Org admin can update members of their org\n  const isOrgAdmin = await checkOrgAdmin(\n    currentUser._id,\n    args.targetUserId\n  );\n  \n  if (isOrgAdmin) {\n    return updateUser(args.userId, args.updates);\n  }\n  \n  // Users can only update themselves\n  if (currentUser._id !== args.userId) {\n    throw new Error('Insufficient permissions');\n  }\n  \n  return updateUser(args.userId, args.updates);\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"security-checklist",children:"Security Checklist"}),"\n",(0,i.jsx)(n.p,{children:"When implementing new features, ensure:"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","All mutations require authentication"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Queries for user-specific data verify authentication"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Organization operations check org membership/admin status"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Sensitive fields have field-level authorization"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Tokens are validated on every request"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Token versions are checked against database"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Passwords are hashed using bcrypt (min 12 rounds)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Rate limiting is applied to authentication endpoints"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Security events are logged for audit trail"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Error messages don't leak sensitive information"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Authorization checks happen before database queries"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Refresh tokens are stored in httpOnly cookies"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"testing-authorization",children:"Testing Authorization"}),"\n",(0,i.jsx)(n.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { describe, it, expect } from 'vitest';\n\ndescribe('updateOrganization', () => {\n  it('should throw error if user is not authenticated', async () => {\n    const context = { userId: null };\n    \n    await expect(\n      updateOrganization(null, { id: '123' }, context)\n    ).rejects.toThrow('User not authenticated');\n  });\n  \n  it('should throw error if user is not org admin', async () => {\n    const context = { \n      userId: 'user123',\n      drizzleClient: mockDb \n    };\n    \n    await expect(\n      updateOrganization(null, { id: 'org123' }, context)\n    ).rejects.toThrow('Admin privileges required');\n  });\n  \n  it('should allow org admin to update organization', async () => {\n    const context = {\n      userId: 'admin123',\n      drizzleClient: mockDb\n    };\n    \n    const result = await updateOrganization(\n      null,\n      { id: 'org123', name: 'New Name' },\n      context\n    );\n    \n    expect(result.name).toBe('New Name');\n  });\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"integration-tests",children:"Integration Tests"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"describe('Authentication Flow', () => {\n  it('should login and use access token for authenticated request', async () => {\n    // 1. Login\n    const loginResponse = await request(app)\n      .post('/graphql')\n      .send({\n        query: `\n          mutation {\n            login(email: \"test@example.com\", password: \"password123\") {\n              accessToken\n              user { _id }\n            }\n          }\n        `\n      });\n    \n    const { accessToken } = loginResponse.body.data.login;\n    \n    // 2. Use token for authenticated request\n    const profileResponse = await request(app)\n      .post('/graphql')\n      .set('Authorization', `Bearer ${accessToken}`)\n      .send({\n        query: `\n          query {\n            me { email }\n          }\n        `\n      });\n    \n    expect(profileResponse.body.data.me.email).toBe('test@example.com');\n  });\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.p,{children:"Required authentication-related environment variables:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# JWT Secrets (use long, random strings in production)\nACCESS_TOKEN_SECRET=your-access-token-secret-min-32-chars\nREFRESH_TOKEN_SECRET=your-refresh-token-secret-min-32-chars\n\n# Token Expiration\nACCESS_TOKEN_EXPIRY=15m\nREFRESH_TOKEN_EXPIRY=7d\n\n# Password Requirements\nPASSWORD_MIN_LENGTH=8\nPASSWORD_REQUIRE_SPECIAL_CHAR=true\nPASSWORD_REQUIRE_NUMBER=true\n"})}),"\n",(0,i.jsx)(n.h2,{id:"common-pitfalls",children:"Common Pitfalls"}),"\n",(0,i.jsx)(n.h3,{id:"1-not-checking-authentication",children:"1. Not Checking Authentication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// WRONG - Anyone can create an organization\nexport const createOrganization = async (parent, args, context) => {\n  return await createOrg(args);\n};\n\n// RIGHT - Only authenticated users can create\nexport const createOrganization = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  return await createOrg(currentUser, args);\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-trusting-client-provided-user-ids",children:"2. Trusting Client-Provided User IDs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// WRONG - Client can pass any userId\nexport const updateProfile = async (parent, args, context) => {\n  return await updateUser(args.userId, args.updates);\n};\n\n// RIGHT - Use authenticated user's ID from context\nexport const updateProfile = async (parent, args, context) => {\n  const currentUser = assertUserAuthenticated(context);\n  return await updateUser(currentUser._id, args.updates);\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-forgetting-to-check-token-version",children:"3. Forgetting to Check Token Version"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// WRONG - Doesn't check if token was revoked\nconst payload = verify(token, SECRET);\ncontext.userId = payload.userId;\n\n// RIGHT - Verify token version matches database\nconst payload = verify(token, SECRET);\nconst user = await getUserById(payload.userId);\nif (user.tokenVersion === payload.tokenVersion) {\n  context.userId = user._id;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-exposing-sensitive-data-in-errors",children:"4. Exposing Sensitive Data in Errors"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// WRONG - Reveals user existence\nif (!user) {\n  throw new Error('No user found with email: user@example.com');\n}\n\n// RIGHT - Generic error message\nif (!user) {\n  throw new Error('Invalid credentials');\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"further-reading",children:"Further Reading"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc8725",children:"JWT Best Practices"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html",children:"OWASP Authentication Cheat Sheet"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.apollographql.com/docs/apollo-server/security/authentication/",children:"GraphQL Authorization Best Practices"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/bcryptjs",children:"bcrypt Documentation"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(n.p,{children:"Implementing proper authentication and authorization is critical for API security. Key takeaways:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Always verify authentication before processing requests"}),"\n",(0,i.jsx)(n.li,{children:"Check authorization before accessing or modifying resources"}),"\n",(0,i.jsx)(n.li,{children:"Use JWT tokens with version control for revocation"}),"\n",(0,i.jsx)(n.li,{children:"Implement role-based access control for permissions"}),"\n",(0,i.jsx)(n.li,{children:"Secure tokens using httpOnly cookies for refresh tokens"}),"\n",(0,i.jsx)(n.li,{children:"Hash passwords with bcrypt (minimum 12 rounds)"}),"\n",(0,i.jsx)(n.li,{children:"Rate limit authentication attempts"}),"\n",(0,i.jsx)(n.li,{children:"Log security-critical operations"}),"\n",(0,i.jsx)(n.li,{children:"Test authorization logic thoroughly"}),"\n",(0,i.jsx)(n.li,{children:"Follow the principle of least privilege"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"By following these patterns and best practices, you ensure that the Talawa API maintains a robust security posture while providing a good developer experience."})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);