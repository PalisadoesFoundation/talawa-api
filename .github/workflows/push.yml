name: Push Workflow for develop

on:
  workflow_dispatch:
  push:
    branches:
      - develop

env:
  CODECOV_UNIQUE_NAME: CODECOV_UNIQUE_NAME-${{ github.run_id }}-${{ github.run_number }}
  TOTAL_SHARDS: 12
  
jobs:
  test-and-upload-coverage:
    name: Run tests (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      # Create .env file for Talawa API testing environment
      - name: Create .env file for Talawa API testing environment
        run: cp ./envFiles/.env.ci ./.env

      # Build Talawa API compose testing environment
      - name: Build Talawa API compose testing environment
        run: docker compose build

      # Run tests with sharding
      - name: Run tests (shard ${{ matrix.shard }}/${{ env.TOTAL_SHARDS }})
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_COUNT: ${{ env.TOTAL_SHARDS }}
        run: |
          # Run tests without --rm to allow coverage extraction
          docker compose run --name talawa-api-test-shard-${{ matrix.shard }} \
            -e SHARD_INDEX=$SHARD_INDEX \
            -e SHARD_COUNT=$SHARD_COUNT \
            api pnpm test:shard:coverage

      - name: Copy coverage from container
        if: always()
        run: |
          # Copy coverage from the named container
          docker cp talawa-api-test-shard-${{ matrix.shard }}:/home/talawa/api/coverage ./coverage || echo "::warning::Failed to copy coverage from container talawa-api-test-shard-${{ matrix.shard }}"
          
      - name: Cleanup test container
        if: always()
        run: |
          # Remove the test container
          docker rm -f talawa-api-test-shard-${{ matrix.shard }} || true

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-shard-${{ matrix.shard }}
          path: ./coverage/
          retention-days: 1

  merge-coverage:
    name: Merge Coverage Reports
    runs-on: ubuntu-latest
    needs: [test-and-upload-coverage]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'pnpm'

      - name: Download all coverage artifacts
        id: download-artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-shard-*
          path: ./coverage-shards/
          merge-multiple: false

      - name: Prepare dependency store
        run: pnpm fetch

      - name: Install dependencies (offline)
        run: pnpm install --frozen-lockfile --offline

      - name: Check if artifacts were downloaded
        id: check-artifacts
        run: |
          # Check if any coverage files exist
          if find coverage-shards -name "lcov.info" -type f | grep -q .; then
            echo "artifacts_found=true" >> $GITHUB_OUTPUT
            echo "Coverage artifacts found"
          else
            echo "artifacts_found=false" >> $GITHUB_OUTPUT
            echo "No coverage artifacts found - tests may have been skipped"
          fi

      - name: Merge coverage reports
        if: steps.check-artifacts.outputs.artifacts_found == 'true'
        run: |
          mkdir -p ./coverage/vitest

          # Find all coverage directories from shards
          echo "Finding coverage data from shards..."
          SHARD_DIRS=$(find coverage-shards -type d -name "coverage-shard-*" 2>/dev/null || true)

          if [ -z "$SHARD_DIRS" ]; then
            echo "ERROR: No shard directories found!"
            ls -la coverage-shards/ || true
            exit 1
          fi

          echo "Found shard directories:"
          echo "$SHARD_DIRS"

          # Use lcov files for merging (works without source files)
          echo "Using LCOV files for merging..."
          find coverage-shards -name "lcov.info" -type f > lcov-files.txt

          if [ ! -s lcov-files.txt ]; then
            echo "ERROR: No lcov.info files found!"
            exit 1
          fi

          echo "Found coverage files:"
          cat lcov-files.txt

          # Count files
          LCOV_COUNT=$(wc -l < lcov-files.txt)
          echo "Total lcov files: $LCOV_COUNT"

          # Validate each file exists and is not empty
          while IFS= read -r file; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Coverage file does not exist: $file"
              exit 1
            fi
            if [ ! -s "$file" ]; then
              echo "ERROR: Coverage file is empty: $file"
              exit 1
            fi
            SF_COUNT=$(grep -c "^SF:" "$file" || echo "0")
            echo "  $file: $SF_COUNT source files"
          done < lcov-files.txt

          # Merge using lcov-result-merger
          echo "Merging coverage with lcov-result-merger..."
          pnpm exec lcov-result-merger "coverage-shards/*/lcov.info" ./coverage/vitest/lcov.info

          # Validate merged file exists and is not empty
          if [ ! -s ./coverage/vitest/lcov.info ]; then
            echo "ERROR: Merged coverage file is empty or missing!"
            exit 1
          fi

          echo "Coverage merge successful"
          echo "Merged file size: $(wc -l < ./coverage/vitest/lcov.info) lines"

          # Count number of source files in merged coverage
          SF_COUNT=$(grep -c "^SF:" ./coverage/vitest/lcov.info || echo "0")
          echo "Number of files in merged coverage: $SF_COUNT"

          # Threshold of 100 source files is based on the project's historical baseline.
          # The talawa-api codebase has 700+ source files, so a merged coverage report
          # with fewer than 100 files likely indicates a failed or incomplete merge.
          # This is a sanity check, not a hard failure - coverage may still be valid.
          COVERAGE_FILE_THRESHOLD=${COVERAGE_FILE_THRESHOLD:-100}
          if [ "$SF_COUNT" -lt "$COVERAGE_FILE_THRESHOLD" ]; then
            echo "::warning::Only $SF_COUNT files in coverage (expected ${COVERAGE_FILE_THRESHOLD}+). This might indicate incomplete coverage merge."

          echo "First 30 lines of merged coverage:"
          head -30 ./coverage/vitest/lcov.info

      - name: Clean up individual shard coverage files
        if: steps.check-artifacts.outputs.artifacts_found == 'true'
        run: |
          echo "Final coverage file to upload:"
          ls -lh ./coverage/vitest/lcov.info
          
      #######################################################################
      # DO NOT DELETE ANY references to env.CODECOV_UNIQUE_NAME in this
      # section. They are required for accurate calculations
      #######################################################################
      - name: Present and upload coverage to Codecov as ${{env.CODECOV_UNIQUE_NAME}}
        if: steps.check-artifacts.outputs.artifacts_found == 'true'
        uses: codecov/codecov-action@v5
        with:
          name: "${{env.CODECOV_UNIQUE_NAME}}"
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true
          exclude: 'docs/'
          gcov_ignore: 'docs/'
          files: ./coverage/vitest/lcov.info
          flags: vitest


