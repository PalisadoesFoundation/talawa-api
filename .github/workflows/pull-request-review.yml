name: Talawa-API Pull Request Review

on:
  pull_request_review:
    types: [submitted]

jobs:
  Check-CodeRabbit-Approval:
    name: Check CodeRabbit Approval for Talawa-API
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Check CodeRabbit approval using GitHub Script
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Log all reviews once for debugging
            reviews.forEach(review =>
              console.log('Reviewer:', review.user.login, 'State:', review.state, 'Submitted at:', review.submitted_at)
            );

            const latestReviewsMap = new Map();

            // Find the latest review per user
            for (const review of reviews) {
              const login = review.user.login.toLowerCase();

              // Only consider actual reviews, not comments
              const validStates = ['APPROVED', 'CHANGES_REQUESTED', 'DISMISSED'];
              if (!validStates.includes(review.state)) continue;

              if (login.includes('coderabbit')) {
                const existing = latestReviewsMap.get(login);
                if (!existing || new Date(review.submitted_at) > new Date(existing.submitted_at)) {
                  latestReviewsMap.set(login, review);
                }
              }
            }

            const codeRabbitReviews = Array.from(latestReviewsMap.values());

            // Fail if no CodeRabbit reviews are found
            if (codeRabbitReviews.length === 0) {
              core.setFailed('ERROR: CodeRabbit has not reviewed this PR.');
              return;
            }

            const latestReview = codeRabbitReviews[0];

            if (latestReview.state !== 'APPROVED') {
              core.setFailed(`ERROR: Latest CodeRabbit review is '${latestReview.state}'. Approval is required before merging this PR.`);
            } else {
              console.log('âœ… Success: CodeRabbit has approved this PR.');
            }
